function [xh, yh] = TrackKalman(xm, ym)
% TrackKalman - 관측된 물체의 위치 (xm, ym)를 받아 칼만 필터로 추정된 위치 (xh, yh)를 반환
% persistent 키워드를 통해 필터의 상태를 유지하며 반복적으로 위치를 추정함

% 시스템 행렬 및 상태 초기화 변수 선언 (처음 한 번만 초기화)
persistent A H Q R         % 시스템 행렬 및 잡음 공분산 행렬
persistent x P             % 상태 추정 벡터 및 오차 공분산 행렬
persistent firstRun        % 초기화 여부 확인 변수

% 처음 실행 시 필터 변수 초기화
if isempty(firstRun)
  dt = 1;  % 시간 간격 (프레임 간 고정 간격 가정)

  % 상태 전이 행렬 A: (위치, 속도) → 다음 위치 예측
  A = [ 1  dt  0   0
        0  1   0   0
        0  0   1  dt
        0  0   0   1 ];
  
  % 관측 행렬 H: 상태 벡터 중 위치 값만 측정 가능
  H = [ 1  0  0  0
        0  0  1  0 ];

  % 프로세스 잡음 공분산 Q: 모델의 불확실성
  Q = 1.0 * eye(4);

  % 측정 잡음 공분산 R: 측정값의 불확실성
  R = [ 50  0
         0 50 ];

  % 상태 벡터 x 초기값: [x위치, x속도, y위치, y속도]
  x = [0, 0, 0, 0]';

  % 상태 오차 공분산 P 초기값
  P = 100 * eye(4);

  % 초기화 완료 표시
  firstRun = 1;
end

% 예측 단계
xp = A * x;                % 다음 상태 예측
Pp = A * P * A' + Q;       % 예측 상태 오차 공분산

% 칼만 이득 계산
K = Pp * H' * inv(H * Pp * H' + R);

% 측정값 벡터 z
z = [xm ym]';

% 업데이트 단계
x = xp + K * (z - H * xp); % 상태 업데이트
P = Pp - K * H * Pp;       % 오차 공분산 업데이트

% 추정된 위치 반환
xh = x(1);  % x축 위치 추정값
yh = x(3);  % y축 위치 추정값
